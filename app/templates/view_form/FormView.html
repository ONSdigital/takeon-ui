{% extends "base.html" %}
​
{% block title %}Contributor Details{% endblock title %}
​
{% block page_header %}
​
    Data Clearing
​
{% endblock page_header %}

{% block content %}

​<div class="mainContent">
    <div class="grid">
        <div class="grid__col col-11@m">

            <h1>{{ contributor_details['referencename'] }}</h1>

            <dl class="metadata metadata__list grid grid--gutterless u-cf u-mb-s" title="Form details" aria-label="Form details">
                <dt class="metadata__term grid__col col-2@m u-mt-no">Reference:</dt>
                <dd class="metadata__value grid__col col-10@m u-mt-no">{{ ruref }}</dd>
                <dt class="metadata__term grid__col col-2@m u-mt-no">Survey:</dt>
                <dd class="metadata__value grid__col col-10@m u-mt-no">{{ survey }}</dd>
                <dt class="metadata__term grid__col col-2@m u-mt-no">Period:</dt>
                <dd class="metadata__value grid__col col-10@m u-mt-no">{{ period }}</dd>
                <dt class="metadata__term grid__col col-2@m u-mt-no">Cell:</dt>
                <dd class="metadata__value grid__col col-10@m u-mt-no">{{ contributor_details['cellnumber'] }}</dd>
                <dt class="metadata__term grid__col col-2@m u-mt-no">Frozen Employment:</dt>
                <dd class="metadata__value grid__col col-10@m u-mt-no">{{ contributor_details['frozenemployment'] }}</dd>
                <dt class="metadata__term grid__col col-2@m u-mt-no">Frozen SIC 2003:</dt>
                <dd class="metadata__value grid__col col-10@m u-mt-no">{{ contributor_details['frozensicoutdated'] }}</dd>
                <dt class="metadata__term grid__col col-2@m u-mt-no">Frozen SIC 2007:</dt>
                <dd class="metadata__value grid__col col-10@m u-mt-no">{{ contributor_details['frozensic'] }}</dd>
            </dl>

            <p class="u-bb u-pb-s">
                <span title="Status " class="{{ status_colour }}">{{ contributor_details['status'] }}</span>
            </p>

            <section role="region" class="tabs">
                <h2 class="tabs__title">Tabs</h2>

                <ul class="tabs__list tabs__list--row">
                    <li id="tabId1Item" class="tab__list-item">
                        <a href="#tabId1" class="tab tab--row" data-ga="click" data-ga-category="tabs" data-ga-action="Show: Current Data" data-ga-label="Show: Current Data" aria-selected="true">Current Data</a></li>
                    <li id="tabId2Item" class="tab__list-item">
                        <a href="#tabId2" class="tab tab--row" data-ga="click" data-ga-category="tabs" data-ga-action="Show: Historic Data" data-ga-label="Show: Historic Data" aria-selected="false">Historic Data</a></li>
                </ul>

                <form method="post" id="responseForm" action="{{ url_for('view_form.view_form', inqcode=survey, period=period, ruref=ruref) }}" onSubmit="return disableButton(this);">

                    <section id="tabId1" class="tabs__panel">

                        <table id="basic-table" class="table ">

                            <thead class="table__head">
                                <tr class="table__row">
                                    <th scope="col" class="table__header col-1@m">Number</th>
                                    <th scope="col" class="table__header col-4@m">Question</th>
                                    <th scope="col" class="table__header col-2@m">Response</th>
                                    <th scope="col" class="table__header col-2@m">Adjusted Response</th>
                                    <th scope="col" class="table__header ">Question Status</th>
                                </tr>
                            </thead>

                            <tbody class="table__body">

                                {% for datum in data['form_validation_outputs'] %}
                                    <tr class="table__row">
                                        {% if datum['validation_info']|length > 0 %}
                                            <td class="table__cell ">
                                                <p class="field">
                                                    <label for="{{ datum['questioncode'] }}"> {{ datum["displayquestionnumber"] }} </label>
                                                </p>
                                            </td>

                                            <td class="table__cell ">
                                                <p class="field">
                                                    <label for="{{ datum['questioncode'] }}"> {{ datum["displaytext"] }} </label>
                                                </p>
                                            </td>

                                            <td class="table__cell ">
                                                {% if datum['type'] == 'NUMERIC' %}
                                                    <p class="field">
                                                        <input name="{{ datum['questioncode'] }}" value="{{ datum['response'] }}" type="number" id="{{ datum['questioncode'] }}" class="input input--text input-type__input input--w-10">
                                                    </p>
                                                {% else %}
                                                    <p class="field">
                                                        <input name="{{ datum['questioncode'] }}" value="{{ datum['response'] }}" type="text" id="{{ datum['questioncode'] }}" class="input input--text input-type__input input--w-10">
                                                    </p>
                                                {% endif %}
                                            </td>

                                            <td class="table__cell ">
                                                {% if datum['type'] == 'NUMERIC' %}
                                                    {% if datum['adjustedresponse'] == NULL %}
                                                        <p class="field">
                                                            <label for="{{ datum['questioncode'] }}"></label>
                                                        </p>
                                                    {% else %}
                                                        <p class="field">
                                                            <label for="{{ datum['questioncode'] }}"> {{ datum["adjustedresponse"] }} </label>
                                                        </p>
                                                    {% endif %}
                                                {% endif %}
                                            </td>

                                            <td class="table__cell ">
                                                <div class="panel {{ datum['panel'] }} panel--simple">
                                                    <div class="panel__body">

                                                        {% for output in datum['validation_info'] %}

                                                            {% if output['overridden'] == True %}
                                                                <span class="checkbox js-password-toggle-wrap checkbox--toggle u-mt-no u-mb-s">
                                                                    <input type="checkbox" id="{{output['validationoutputid']}}" class="checkbox__input js-checkbox js-password-toggle to-u-bg-w" name="override-checkbox" checked>
                                                                    <label id="label-{{output['validationoutputid']}}" class="checkbox__label to-u-bg " for="{{output['validationoutputid']}}"><strong>Overridden - </strong>'{{ output["description"] }}'</label>
                                                                </span>
                                                            
                                                            {% else %}
                                                                <p class="panel__error u-mb-no">
                                                                    {% if output['severity'] == 'W' %}
                                                                    <strong>Warning - </strong> {{output['description']}} 
                                                                </p>

                                                                <span class="checkbox js-password-toggle-wrap checkbox--toggle u-mt-no u-mb-s">
                                                                    <input type="checkbox" id="{{output['validationoutputid']}}" class="checkbox__input js-checkbox js-password-toggle to-u-bg-w " name="override-checkbox">
                                                                    <label id="label-{{output['validationoutputid']}}" class="checkbox__label to-u-bg" for="{{output['validationoutputid']}}"><strong>Override </strong> <span class="u-vh">{{ output["description"] | lower }} </span></label>
                                                                </span>
                                                                <br>

                                                                {% else %}
                                                                <p class="panel__error u-mb-no">
                                                                    <strong>Error - </strong> {{output['description']}}
                                                                </p>
                                                                <br>
                                                            
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </td>

                                        {% else %}

                                            <td class="table__cell ">
                                                <p class="field">
                                                    <label for="{{ datum['questioncode'] }}"> {{ datum["displayquestionnumber"] }} </label>
                                                </p>
                                            </td>

                                            <td class="table__cell ">
                                                <p class="field">
                                                    <label for="{{ datum['questioncode'] }}"> {{ datum["displaytext"] }} </label>
                                                </p>
                                            </td>

                                            <td class="table__cell ">
                                                {% if datum['type'] == 'NUMERIC' %}
                                                    <p class="field">
                                                        <input name="{{ datum['questioncode'] }}" value="{{ datum['response'] }}" type="number" id="{{ datum['questioncode'] }}" class="input input--text input-type__input input--w-10">
                                                    </p>
                                                {% else %}
                                                    <p class="field">
                                                        <input name="{{ datum['questioncode'] }}" value="{{ datum['response'] }}" type="text" id="{{ datum['questioncode'] }}" class="input input--text input-type__input input--w-10">
                                                    </p>
                                                {% endif %}
                                            </td>

                                            <td class="table__cell ">
                                                {% if datum['type'] == 'NUMERIC' %}
                                                    {% if datum['adjustedresponse'] == NULL %}
                                                        <p class="field">
                                                            <label for="{{ datum['questioncode'] }}"></label>
                                                        </p>
                                                    {% else %}
                                                        <p class="field">
                                                            <label for="{{ datum['questioncode'] }}"> {{ datum["adjustedresponse"] }} </label>
                                                        </p>
                                                    {% endif %}
                                                {% endif %}
                                            </td>

                                            <td class="table__cell ">
                                            </td>

                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        {% if override_button %}
                            <hr>
                            <fieldset class="fieldset">
                                <legend class="fieldset__legend u-vh">Override all</legend>
                                <p class="checkboxes__label"></p>
                                <span class="checkboxes__items ">
                                    <p class="checkboxes__item">
                                        <span class="checkbox input--w-10 ">
                                            <input type="checkbox" id="select-all" class="checkbox__input js-checkbox " value="Select All" name="select-all-checkbox" onclick="select_all(this)">
                                            <label id="label-select-all" class="checkbox__label " for="select-all">Override all</label>
                                        </span>
                                    </p>
                                </span>
                            </fieldset>
                        {% endif %}

                        <br>
                        <br>

                        <button class="btn btn--small" type="submit" id="saveFormButton" value="save-and-validate" name="action" onclick="popup()">
                            <span class="btn__inner">Save and validate</span>
                        </button>

                        <button class="btn btn--small" type="submit" value='override' name='action' id='override_button'>
                            <span class="btn__inner">Override</span>
                        </button>
                    </section>


                    <section id="tabId2" class="tabs__panel">

                        <table class="table table--responsive">
                            <thead class="table__head">
                                <tr class="table__row">
                                    <th scope="col" class="table__header">
                                        <span>Question</span>
                                    </th>
                                    {% for row in historic_data['history_data'] %}
                                        <th scope="col" class="table__header table__cell--numeric">
                                            <span>{{ row['period'] }}</span>
                                        </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            
                            <tbody class="table__body">
                                {% for row in grouped_historic_data.items() %}
                                    <tr class="table__row">
                                        <td class="table__cell" data-th="Question">
                                            {{ row[0] }}
                                        </td>
                                        {% for response in row[1] %}
                                        <td class="table__cell table__cell--numeric">
                                            {{ response }}
                                        </td>
                                        {% endfor %}
                                    </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </section>
                
                </form>

            </section>

            <br>
            <br>
            <br>

        </div>
    </div>
</div>

{% endblock content %}

<script>
    var override_button = document.getElementById("override_button")
    override_button.addEventListener("click", function()
    {var checkboxes = document.getElementsByName("override-checkbox");
        var reference  = "{{ contributor_details['reference'] }}";
        var period     = "{{ contributor_details['period'] }}";
        var survey     = "{{ contributor_details['survey'] }}";
        var user       = '{{ user }}';
        var checkboxes_checked = []
        var checkboxes_output  = {}
        for(var i = 0; i < checkboxes.length; i++) {
            if(checkboxes[i].checked) {
                var checkbox = {}
                checkbox["validationoutputid"] = checkboxes[i].id
                checkbox["override"]           = true
                checkbox["user"]               = user
                checkboxes_checked.push(checkbox)
            } else {
                var checkbox = {}
                checkbox["validationoutputid"] = checkboxes[i].id
                checkbox["override"]           = false
                checkbox["user"]               = user
                checkboxes_checked.push(checkbox)
            }
        }
        checkboxes_output['reference']          = reference
        checkboxes_output['period']             = period
        checkboxes_output['survey']             = survey
        checkboxes_output['validation_outputs'] = checkboxes_checked
        var js_data = JSON.stringify(checkboxes_output)
        $.ajax({
            url: 'override-validations',
            type: 'post',
            contentType: 'application/json',
            dataType: 'json',
            data: js_data,
            async: false
        })
        window.location.reload()})
</script>

<script>
    function select_all(source) {
        checkboxes = document.getElementsByName("override-checkbox");
        for(var i=0; i < checkboxes.length; i++){
            checkboxes[i].checked = source.checked;
        }
    }
</script>

<script>
    function popup() {
        var w = window.open('','','width=auto,height=auto')
	    w.document.write(`<!doctype html>
        <html lang="en-gb" dir="ltr" class="no-js">

        <head>

            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title></title>
            <link rel="stylesheet" href="https://cdn.ons.gov.uk/sdc/design-system/24.0.3/css/main.css">
            <meta name="msapplication-config"
                content="https://cdn.ons.gov.uk/sdc/design-system/24.0.3/favicons/browserconfig.json">
            <link rel="icon" type="image/x-icon" href="https://cdn.ons.gov.uk/sdc/design-system/24.0.1/favicons/favicon.ico">
            <link rel="icon" type="image/png"
                href="https://cdn.ons.gov.uk/sdc/design-system/24.0.3/favicons/favicon-32x32.png" sizes="32x32">
            <link rel="icon" type="image/png"
                href="https://cdn.ons.gov.uk/sdc/design-system/24.0.3/favicons/favicon-16x16.png" sizes="16x16">
            <link rel="mask-icon" color="#5BBAD5"
                href="https://cdn.ons.gov.uk/sdc/design-system/24.0.3/favicons/safari-pinned-tab.svg">
            <link rel="apple-touch-icon" type="image/png"
                href="https://cdn.ons.gov.uk/sdc/design-system/24.0.3/favicons/apple-touch-icon.png" sizes="180x180">
            <link rel="manifest" href="https://cdn.ons.gov.uk/sdc/design-system/24.0.3/favicons/manifest.json">
                    <link rel="stylesheet" href="https://cdn.ons.gov.uk/sdc/design-system/16.1.0/css/main.css" media="all"
                        type="text/css">
                    <link rel="stylesheet" href="{{ url_for('static',filename='css/custom.css') }}" media="all" type="text/css">
                    <script>var ONS_assets_base_URL='https://cdn.ons.gov.uk/sdc/design-system/24.0.3/';</script>
                    <script src="https://cdn.ons.gov.uk/sdc/design-system/24.0.3/scripts/main.js"></script>

                    <script type="text/javascript"
                            src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
                    <script type="text/javascript" src="{{ url_for('static', filename='js/industry-range.js') }}"></script>

        </head>

        <body>
        <div class="phase-banner mainContent">
            <div class="grid grid--flex grid--gutterless grid--vertical-center grid--no-wrap">
                <div class="grid__col col-auto u-flex-no-grow">
                    <h3 class="phase-banner__badge">BETA</h3>
                </div>
                <div class="grid__col col-auto u-flex-shrink">
                    <p class="phase-banner__desc u-fs-s u-mb-no">This is a work in progress</p>
                </div>
            </div>
        </div>

        <header class="header header--internal header--thin">
            <div class="header__top mainContent" role="banner">
                <div class="header__grid-top grid grid--gutterless grid--flex grid--between grid--vertical-center grid--no-wrap">
                    <div class="grid__col col-auto">
                        <a class="header__logo-link" href="/">
                            <img class="header__logo" src="{{ url_for('static',filename='img/ons-logo-white.svg') }}"
                                alt="Office for National Statistics logo">
                        </a>
                    </div>
                </div>
            </div>
            <div class="header__main">
                <div class="grid grid--gutterless grid--flex grid--between grid--vertical-center grid--no-wrap mainContent">
                    <div class="grid__col col-auto u-flex-shrink">
                        <div class="header__title">
                        </div>
                    </div>

                    <div class="grid__col col-auto u-flex-no-shrink u-d-no@xs@m">
                        <a href="{{ url_for('auth.logout') }}" role="button" class="btn btn--ghost u-d-no@xs@m btn--exit">
                        <span class="btn__inner">Sign out
                            <svg class="svg-icon" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13.85,7.65l-2.5-2.5a.5.5,0,0,0-.71,0,.48.48,0,0,0-.15.36V7h-3a.5.5,0,0,0-.5.5v1a.5.5,0,0,0,.5.5h3v1.5A.49.49,0,0,0,11,11a.48.48,0,0,0,.34-.14l2.51-2.5a.49.49,0,0,0,0-.68Z" transform="translate(-2 -2)" />
                            <path d="M8.5,14h-6a.5.5,0,0,1-.5-.5V2.5A.5.5,0,0,1,2.5,2h6a.5.5,0,0,1,.5.5V3a.5.5,0,0,1-.5.5h-5v9h5A.5.5,0,0,1,9,13v.5A.5.5,0,0,1,8.5,14Z" transform="translate(-2 -2)" />
                            </svg>
                        </span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <body> 
            <h1>Loading, please wait</h1>
        </body>


        <footer class="footer " data-ga-element="footer">
            <div class="container">
                <div class="grid">
                    <div class="grid__col col-4@m">
                        <!-- Footer text here -->
                    </div>
                    <div class="grid__col u-mt-m u-mb-m">
                        <hr class="footer__hr">
                    </div>
                    <div class="grid__col">
                        <div class="footer__license">
                            <img alt="OGL" class="footer__ogl-img"
                                src="{{ url_for('static',filename='img/UKOpenGovernmentLicence-grey.svg') }}">
                            All content is available under the <a
                                href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
                                class="footer__link">Open Government Licence v3.0</a>, except where otherwise stated
                        </div>
                    </div>
                </div>
            </div>
        </footer>

        </body>

        </html>`)
	    w.focus()
	    setTimeout(function() {w.close();}, 5000)
        }
</script>


