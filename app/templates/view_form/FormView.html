{% extends "base.html" %}

{% block title %}Contributor Details{% endblock title %}


{% block page_header %}

    <h1 class="jupiter main_heading">Take-On</h1>

{% endblock page_header %}

<br>
{% block content %}

    <div class="mainContent">
        <div class="grid">
            <div class="grid__col col-7@m paddingSection">

                <dl class="metadata metadata__list grid grid--gutterless u-cf u-mb-s" title="Form details" aria-label="Form details">
                    <h1>{{ contributor_details['referencename'] }}</h1>
                    <dt class="metadata__term grid__col col-2@m u-mt-no">Reference:</dt>
                    <dd id="ref" class="metadata__value grid__col col-10@m u-mt-no">{{ contributor_details['reference'] }}</dd>
                    <dt class="metadata__term grid__col col-2@m u-mt-no">Survey:</dt>
                    <dd id="survey" class="metadata__value grid__col col-10@m u-mt-no">{{ contributor_details['surveyBySurvey']['description'] }} {{ contributor_details['survey'] }}</dd>
                    <dt class="metadata__term grid__col col-2@m u-mt-no">Period:</dt>
                    <dd id="period" class="metadata__value grid__col col-10@m u-mt-no">{{ contributor_details['period'] }}</dd>
                </dl>

                <p class="u-bb u-pb-s">
                    <span title="Status " class="{{ status_colour }}">{{ contributor_details['status'] }}</span>
                </p>

                <form method="post" id="responseForm">
                    
                    {% for datum in data['form_validation_outputs'] %}
                    
                        {% if datum['validation_info']|length > 0 %}

                        <div class="panel {{ datum['panel'] }} panel--simple">
                            <div class="panel__body">
                                {% for output in datum['validation_info'] %}

                                    {% if output['overridden'] == True %}

                                    <p class="checkboxes__item ">
                                        <span class="checkbox ">
                                            <input type="checkbox" id="{{output['validationoutputid']}}" class="checkbox__input js-checkbox checkboxAlignment" value="{{output['validationoutputid']}}" name="override-checkbox" checked>
                                            <p class="field">
                                            <label id="{{output['validationoutputid']}}-label" class="checkbox__label checkboxTextAlignment" for="{{output['validationoutputid']}}"> <strong>{{ output["name"] }}</strong></br></label>
                                            </p>
                                        </span>
                                    </p>

                                    {% else %}

                                    <p class="checkboxes__item ">
                                        <span class="checkbox ">
                                            <p class="field">
                                                <input type="checkbox" id="{{output['validationoutputid']}}" class="checkbox__input js-checkbox checkboxAlignment" value="{{output['validationoutputid']}}" name="override-checkbox">    
                                                <p class="panel__error">
                                                    <label id="{{output['validationoutputid']}}-label" class="checkbox__label checkboxTextAlignment" for="{{output['validationoutputid']}}"> <strong>{{ output["name"] }}</strong></br></label>
                                                </p>
                                            </p>
                                        </span>
                                    </p>

                                    {% endif %}

                                {% endfor %}


                                <strong>{{ datum["displayquestionnumber"] }}</strong> <strong> {{ datum["displaytext"] }}</strong>
                                <br>
                                <br>
                                <input name="{{ datum['questioncode'] }}" value="{{ datum['response'] }}" type="number" class="input input--text input-type__input">
                            </div>
                        </div>

                        {% else %}

                        <strong>{{ datum["displayquestionnumber"] }}</strong> <strong> {{ datum["displaytext"] }}</strong>
                        <br>
                        <br>
                        <input name="{{ datum['questioncode'] }}" value="{{ datum['response'] }}" type="number" class="input input--text input-type__input">

                        {% endif %}

                        <br>
                        <br>

                    {% endfor %}

                </form>

                <span class="checkbox overrideBoxLength">
                    <input type="checkbox" id="select-all" class="checkbox__input js-checkbox checkboxAlignment" value="Select All" name="select-all-checkbox" onclick="select_all(this)">
                    <label id="select_all" class="checkbox__label checkboxTextAlignment" for="select-all">
                        <strong>Override All</strong>
                    </label>
                </span>
                <br>
                <br>
            </div> 
        </div>
    </div>


    <div class="mainContent">
    <form method="POST" action="">

        <button class="btn btn--small" type="submit" id="saveFormButton" value="saveForm" name="action">
            <span class="btn__inner">Save</span>
        </button>

        <button class="btn btn--small" type="submit" class="btn btn-group__btn btn--loader js-loader js-submit-btn" value='validate' name='action'>
            <span class="btn__inner">Validate</span>
        </button>

        <button class="btn btn--small" type="submit" class="btn btn-group__btn btn--loader js-loader js-submit-btn" value='override' name='action' id='override_button'>
            <span class="btn__inner">Override</span>
        </button>

        <button class="btn btn--small" type="submit" value="close this window" onclick="self.close()">
            <span class="btn__inner">Exit</span>
        </button>
    </form>
    </div>

    <br>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script>
        var override_button = document.getElementById("override_button")
        override_button.addEventListener("click", function()
        {var checkboxes = document.getElementsByName("override-checkbox");
           var reference  = document.getElementById("ref").textContent;
           var period     = document.getElementById("period").textContent;
           var survey     = document.getElementById("survey").textContent;
           var user       = '{{ user }}';
           var checkboxes_checked = []
           var checkboxes_output  = {}
           for(var i = 0; i < checkboxes.length; i++) {
                if(checkboxes[i].checked) {
                    var checkbox = {}
                    checkbox["validationoutputid"] = checkboxes[i].id
                    checkbox["override"]           = true
                    checkbox["user"]               = user
                    checkboxes_checked.push(checkbox)
                } else {
                    var checkbox = {}
                    checkbox["validationoutputid"] = checkboxes[i].id
                    checkbox["override"]           = false
                    checkbox["user"]               = user
                    checkboxes_checked.push(checkbox)
                }
           }
            checkboxes_output['reference']          = reference
            checkboxes_output['period']             = period
            checkboxes_output['survey']             = survey
            checkboxes_output['validation_outputs'] = checkboxes_checked
            var js_data = JSON.stringify(checkboxes_output)
            $.ajax({
               url: 'override-validations',
               type: 'post',
               contentType: 'application/json',
               dataType: 'json',
               data: js_data,
               async: false
           })
           })
           
    </script>

    <script>
        function select_all(source) {
            checkboxes = document.getElementsByName("override-checkbox");
            for(var i=0; i < checkboxes.length; i++){
                checkboxes[i].checked = source.checked;
            }
        }
    </script>


    <script>
        var statusMessage = "{{ status_message }}"
        console.log(statusMessage)
        if (statusMessage == "&#34;&#34;"){
        }
        else {
            alert(statusMessage);
        }
    </script>

    <script>
        var saveFormButton = document.getElementById("saveFormButton")
        saveFormButton.addEventListener("click", function()
        {response_form = document.getElementById("responseForm");
        console.log("Response Form = " + response_form)
        var reference  = document.getElementById("ref").textContent;
        var period     = document.getElementById("period").textContent;
        var survey     = document.getElementById("survey").textContent;
        var contributor_data = {}
        var edited_response_data = []
        contributor_data['reference'] = reference
        contributor_data['period'] = period
        contributor_data['survey'] = survey
        for (var i = 0; i < response_form.length; i++){
            var question_response = {}
            console.log(response_form.elements[i].name);
            console.log(response_form.elements[i].value);
            question_number = response_form.elements[i].name
            value = response_form.elements[i].value
            question_response['question'] = question_number
            question_response['response'] = value
            question_response['instance'] = 0
            edited_response_data.push(question_response)
            }
            contributor_data['responses'] = edited_response_data
        var js_data = JSON.stringify(contributor_data)
        $.ajax({
            url: 'save-responses',
            type: 'post',
            contentType: 'application/json',
            dataType: 'json',
            data: js_data,
            async: false
        })
        })
    </script>

{% endblock content %}